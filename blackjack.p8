pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- blackjack
-- by koval

-- game logic vars
hand = {}
dealer = {}
player_score=0
dealer_score=0

-- technical vars
frame_counter = 1
stage = 0 
hidden_card = false
item=0 item_lim=3

-- objects coords
dealerx=10 dealery=10
handx=10   handy=100
deckx=100  decky=10
menux=20   menuy=32
sizex=40   sizey=40

-- graphics vars
cursor_anim_frame = 0
draw_window = false

function draw_card(x,y,n,m)
 if m>1 then pal(8,0)
 else pal() end
 n+=1
 sspr(8,0,11,16,x,y) --blank card
 sspr(128-n*8,0,6,6,x+2,y+2) --value
 sspr(24+m*8,8,5,5,x+3,y+9) --type
end

function draw_card_back(x,y)
 sspr(8,0,11,16,x,y)
 sspr(8,16,7,12,x+2,y+2)
end

function generate_card()
 return {flr(rnd(13)),flr(rnd(4))}
end

function add_hard_score(card)
 val=0
 if (card[1]==0) then 
 elseif card[1]>9 then val=10
 else val=card[1]+1 end
 player_score+=val
end

function add_soft_score(card)
 val=0
 if card[1]==0 then
  if player_score<11 then val=11
  else val=1 end
  player_score+=val
 end
end

function count_score(hand)
 player_score=0
 foreach(hand,add_hard_score)
 foreach(hand,add_soft_score)
 return player_score
end
-- main game functions --
-------------------------
function _init()

end

function _draw()
	rectfill(0,0,128,128,3)
	for i=0,3 do
	 draw_card_back(deckx,decky-i*2)
	end

	for k,v in pairs(hand) do
	 draw_card(0+k*11,100,v[1],v[2])
	end
	for k,v in pairs(dealer) do
	 draw_card(0+k*11,10,v[1],v[2])
	end
	if (hidden_card)	draw_card_back(dealerx+11,dealery)
	-- player counter
	print(count_score(hand),64,96,7)
	-- dealer counter
	print(count_score(dealer),64,10,7)
	
	if draw_window then
	 -- window background
	 line(menux,menuy-1,menux+sizex,menuy-1,7)
	 line(menux,menuy+sizey+1,menux+sizex,menuy+sizey+1,7)
	 line(menux-1,menuy,menux-1,menuy+sizey,7)
	 line(menux+sizex+1,menuy,menux+sizex+1,menuy+sizey,7)
  rectfill(menux,menuy,menux+sizex,menuy+sizey,1)
	 -- text
	 print("hit",menux+2,menuy+2,7)
	 print("stay",menux+2,menuy+10+2,7)
	 print("double",menux+2,menuy+20+2,7)
	 print("fold",menux+2,menuy+30+2,7)
	 -- cursor
		spr(35+cursor_anim_frame,menux-10,menuy+item*10)
		if (cursor_anim_frame>7) cursor_anim_frame=-1
		cursor_anim_frame+=1
		
	end

end

function _update()
 
 if frame_counter % 20 ==0 then
  -- stage 1: give player cards
  if stage==0 then
   if (#hand<2) then
    add(hand,generate_card())
   else stage+=1 end
  -- stage 2: give dealer card
  elseif stage==1 then
   if (#dealer<1) then
    add(dealer,generate_card())
   elseif hidden_card==false then
   	hidden_card = true 
   else stage+=1 end
    
  end
 end
 
 if stage==2 then
  -- exit point: blackjack
  -- if (count_score(hand)==21) stop()
  draw_window=true
  if btnp(3) and item<item_lim then
  item+=1 end
  if btnp(2) and item>0 then
  item-=1 end
 end
 
 -- todo:
 -- if confirm pressed
 -- do somethig
 frame_counter+=1
end

__gfx__
00000000001111111000000080080000088000000088800080088000088000000880000088880000088000008888000000880000088000000880000008800000
00000000017777777100000080880000800800000008000080800800800800008008000080080000800000008000000008080000800800008008000080080000
00700700177777777710000088800000800800000008000080800800088800000880000000800000888000008880000080080000008000000080000080080000
00077000177777777710000080880000800800000008000080800800000800008008000000800000800800000008000088880000000800000800000088880000
00077000177777777710000080080000088000008008000080800800800800008008000008000000800800008008000000080000800800008000000080080000
00700700177777777710000080080000008800000880000080088000088000000880000008000000088000000880000000080000088000008888000080080000
00000000177777777710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777777710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777777710000008080000008000000080000000800000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777777710000088888000088800000888000008880000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777777710000088888000888880008888800080808000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777777710000008880000088800008080800088088000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777777710000000800000008000000888000080808000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777777710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000017777777100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000001111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000711111700000000011000000000000000000000000000000000000000000000000000000770000007700000000000000000000000000000000000000
00000000111111100000000077110000110000000000000000000000000000000000000077000000777700007777000000000000000000000000000000000000
00000000111111100000000077771100771111001111000000000000000000007777000077777700777777007777770000000000000000000000000000000000
00000000111111100000000077777711777777117777111111111111777777777777777777777777777777777777777700000000000000000000000000000000
00000000111111100000000077777777777777777777777777777777111111117777111177777711777777117777777700000000000000000000000000000000
00000000111111100000000077777700777777007777000000000000000000001111000077111100777711007777770000000000000000000000000000000000
00000000111111100000000077770000770000000000000000000000000000000000000011000000771100007777000000000000000000000000000000000000
00000000111111100000000077000000000000000000000000000000000000000000000000000000110000007700000000000000000000000000000000000000
00000000111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000711111700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
